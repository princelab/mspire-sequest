require File.expand_path( File.dirname(__FILE__) + '/../../../tap_spec_helper' )

require 'fileutils'
require 'ms/sequest/srf'

# 'converting a large srf to sqt'
class SRF_TO_DTA < MiniTest::Spec
  def del(file)
    if File.exist?(file)
      if File.directory?(file)
        FileUtils.rm_rf file
      else
        File.unlink(file)
      end
    end
  end

  def initialize(*args)
    super(*args)
    @file = Ms::TESTDATA + '/sequest/opd1_static_diff_mods/000.srf'
    @output = Ms::TESTDATA + '/sequest/opd1_static_diff_mods/000.dta.tmp'
    @srf = Ms::Sequest::Srf.new(@file)
  end

 it 'generates .dta files' do
    @srf.to_dta_files(@output)
    assert File.exist?(@output)
    assert File.directory?(@output)
    # frozen (not verified):
    Dir[@output + "/*.*"].size.must_equal 3893 # the correct number files

    first_file = @output + '/000.2.2.1.dta'
    assert File.exist?(first_file) 
    IO.read(first_file).must_equal SRF_TO_DTA_HELPER::FIRST_SCAN.gsub("\n", "\r\n")
    last_file = @output + '/000.3748.3748.3.dta'
    IO.read(last_file).must_equal SRF_TO_DTA_HELPER::LAST_SCAN.gsub("\n", "\r\n")

    del(@output)
  end
end

# these have been checked against Bioworks .dta output
class SRF_TO_DTA_HELPER
  FIRST_SCAN = <<FINISH
391.045410 1
111.9760 41418
112.7334 88292
113.5366 26129
149.0495 2852380
149.9603 110104
150.5784 4607
155.0269 16524
160.4839 17154
161.9014 6562
164.3866 76498
166.8428 1663866
167.7195 72010
168.6932 57081
197.1318 7933
217.9757 20193
218.7995 15350
222.2156 21254
223.0274 27495
224.9077 16117
225.8955 25061
253.5834 7431
255.3725 25846
257.1512 5435
258.8563 26408
260.1663 261245
260.8121 639646
261.7157 82724
262.3666 4
272.0521 43365
277.7733 159994
278.8569 2140713
279.9355 397598
280.7000 4
289.6417 32978
290.3859 31836
291.7867 15850
296.6268 54212
298.6279 22051
300.0358 156183
301.4895 10696
307.4855 37712
326.8031 18038
351.9654 6909
359.6480 10347
361.1469 21067
364.8312 22587
370.0790 9646
371.6420 57566
372.5771 40545
373.9679 76673
374.6720 70584
388.6606 22746
405.4440 23893
406.4814 27502
407.4128 18959
781.0853 10104
FINISH

LAST_SCAN = <<FINISH
1298.680271 3
143.4669 2110
151.1731 4134
158.8174 2565
178.6293 6114
180.0653 879
185.1647 2364
206.8654 7925
210.2082 1242
212.7631 893
217.7493 2202
227.9120 4343
235.9736 2485
236.9414 679
251.6453 4690
252.6773 7145
271.4644 1504
275.4667 5912
276.7386 1819
278.3312 775
282.7281 963
287.6799 1749
288.4127 2603
291.4518 3082
292.4052 8303
299.5691 5620
302.3057 2007
306.0214 1564
308.7954 3738
312.4962 3964
313.6289 11383
318.9493 1945
319.6918 2781
326.5344 4564
331.2536 7761
334.9482 4798
336.9044 5597
338.8912 5830
342.5128 8324
343.4789 12579
344.8436 3118
347.8993 7021
348.7228 2224
350.6813 2440
357.7631 14220
359.3599 11427
360.3604 23882
361.4866 18834
362.5410 10546
363.6121 2031
364.7948 5664
368.7156 3888
372.0910 7189
372.7358 3329
376.5722 7716
378.0999 11617
378.7952 1641
380.7551 7448
386.0341 12462
389.5078 15551
390.8447 10268
391.4811 500
392.7737 2896
396.4655 3636
397.8859 1616
400.7667 1113
403.2670 8535
404.3947 1578
406.2696 7361
407.2147 919
408.3060 11683
409.6450 14506
410.7079 6735
411.5573 6330
414.0493 2606
414.9775 25274
415.7421 5809
418.6591 2842
420.6404 4050
421.3576 4565
424.9559 4801
425.6238 1578
427.9666 5836
431.1060 4433
431.9570 2428
432.5596 7390
433.4197 2093
441.2332 3196
441.9857 2048
448.1818 3643
449.4305 11621
450.1746 4437
450.8452 3907
451.5736 6557
452.4472 1461
453.9933 3555
465.7043 6213
466.3207 1146
468.4201 3492
482.6788 3357
610.4111 8968
FINISH
end
